"use strict";angular.module("superdesk.editor",[]).directive("sdTextEditor",function(){var a={buttons:["bold","italic","underline","quote"]};return{require:"ngModel",link:function(b,c,d,e){function f(){b.$apply(function(){e.$setViewValue(c.html())})}c.on("input",f),c.on("blur",f),e.$render=function(){c.empty(),c.html(e.$viewValue||"<p></p>"),this.editor=new window.MediumEditor(c,a)}}}}),function(){angular.module("superdesk.menu",["superdesk.menu.notifications","superdesk.static"]).directive("sdSuperdeskView",["template",function(a){return{templateUrl:a("scripts/superdesk/menu/views/superdesk-view.html"),controller:function(){this.flags={menu:!1,notifications:!1}},link:function(a,b,c,d){a.flags=d.flags}}}]).directive("sdMenuWrapper",["$route","superdesk","betaService","userNotifications","template",function(a,b,c,d,e){return{require:"^sdSuperdeskView",templateUrl:e("scripts/superdesk/menu/views/menu.html"),link:function(e,f,g,h){function i(a){_.each(e.menu,function(b){b.isActive=a&&a.href&&a.href.substr(0,b.href.length)===b.href})}e.currentRoute=null,e.flags=h.flags,e.menu=_.values(_.where(b.activities,{category:b.MENU_MAIN})),e.toggleMenu=function(){h.flags.menu=!h.flags.menu},e.toggleNotifications=function(){h.flags.notifications=!h.flags.notifications},e.toggleBeta=function(){c.toggleBeta()},e.$on("$locationChangeStart",function(){h.flags.menu=!1}),e.$watch(function(){return a.current},function(a){e.currentRoute=a||null,i(e.currentRoute)}),e.notifications=d}}}])}(),function(){function a(a,b,c,d){function e(){var a={},b="read."+d.identity._id;return a[b]={$exists:!0},a}function f(a){var b=a._dest||{};return!b[d.identity._id]}var g=500,h=300;this._items=null,this.unread=0,this.reload=function(){var a={where:e(),embedded:{user:1,item:1}};return c("activity").query(a).then(angular.bind(this,function(a){this._items=a._items,this.unread=0,_.each(this._items,function(a){try{a._unread=!a.read[d.identity._id],this.unread+=a._unread?1:0}catch(b){}},this)}))},this.markAsRead=function(a){var b=angular.extend({},a),e=a.read;return e[d.identity._id]=1,c("activity").save(b,{read:e}).then(angular.bind(this,function(){this.unread=_.max([0,this.unread-1]),a._unread=null}))},a.$on("activity",angular.bind(this,function(a,c){f(c)&&b(angular.bind(this,this.reload),h)})),b(angular.bind(this,this.reload),g)}function b(a,b){var c=5e3;return{link:function(d){if(d.notification._unread){var e=b(function(){a.markAsRead(d.notification)},c);d.$on("$destroy",function(){b.cancel(e)})}}}}a.$inject=["$rootScope","$timeout","api","session"],b.$inject=["userNotifications","$timeout"],angular.module("superdesk.menu.notifications",[]).service("userNotifications",a).directive("sdMarkAsRead",b).directive("sdNotifications",["template",function(a){return{require:"^sdSuperdeskView",templateUrl:a("scripts/superdesk/menu/notifications/views/notifications.html"),link:function(a,b,c,d){a.flags=d.flags}}}])}(),function(){function a(){var a=[];this.widget=function(b,c){a.push(angular.extend({},c,{_id:b}))},this.$get=function(){return a}}function b(a,b,c){a.active=null,a.widgets=c,a.activate=function(b){a.active=a.active===b?null:b},angular.forEach(a.widgets,function(c){b[c._id]&&a.activate(c)})}function c(){return{controller:b,templateUrl:"scripts/superdesk-authoring/widgets/views/authoring-widgets.html",transclude:!0}}b.$inject=["$scope","$routeParams","authoringWidgets"],angular.module("superdesk.authoring.widgets",[]).provider("authoringWidgets",a).directive("sdAuthoringWidgets",c)}(),function(){function a(a){this.comments=null,this.fetch=function(b){var c={where:{item:b},embedded:{user:1}};return a.item_comments.query(c).then(angular.bind(this,function(a){this.comments=a._items}))},this.save=function(b){return a.item_comments.save(b)}}function b(a,b,c){function e(){a.item&&c.fetch(a.item._id).then(function(){a.comments=c.comments})}function f(){a.active=b.comments||null}a.text=null,a.saveEnterFlag=!1,a.$watch("item._id",e),a.users=[],a.saveOnEnter=function(b){a.saveEnterFlag&&b.keyCode===d&&!b.shiftKey&&a.save()},a.save=function(){var b=a.text||"";b.length&&(a.text="",a.flags={saving:!0},c.save({text:b,item:a.item._id}).then(e))},a.cancel=function(){a.text=""},a.$on("item:comment",function(b,c){c.item===a.item.guid&&e()}),a.$on("$locationChangeSuccess",f),f()}function c(a){return{scope:{comment:"="},link:function(b,c,d){var e;e=d.text.replace(/(?:\r\n|\r|\n)/g,"</p><p>");var f=e.match(/\@([a-zA-Z0-9-_.]\w+)/g);_.each(f,function(a){var c=a.substring(1,a.length);b.comment.mentioned_users&&b.comment.mentioned_users[c]&&(e=e.replace(a,'<i sd-user-info data-user="'+b.comment.mentioned_users[c]+'">'+a+"</i>"))}),c.html("<p><b>"+d.name+"</b> : "+e+"</p>"),a(c.contents())(b)}}}var d=13;a.$inject=["api"],b.$inject=["$scope","$routeParams","commentsService","api","$q"],c.$inject=["$compile"],angular.module("superdesk.authoring.comments",["superdesk.authoring.widgets","mentio"]).config(["authoringWidgetsProvider",function(a){a.widget("comments",{icon:"comments",label:gettext("Comments"),template:"scripts/superdesk-authoring/comments/views/comments-widget.html"})}]).config(["apiProvider",function(a){a.api("item_comments",{type:"http",backend:{rel:"item_comments"}})}]).controller("CommentsWidgetCtrl",b).service("commentsService",a).directive("sdCommentText",c)}(),function(){function a(a,b,c){return function(){this.create=function(){var d={type:"text"};a("archive").save(d).then(function(){c.add(d),b.intent("author","article",d)})}}}function b(a,b){return function(c){var d,e,f=a("content_view");this.flags={},this.views=null,this.selected=null,this.select=function(a){this.selected=a||null},this.edit=function(a){this.edited=_.create(a),d=a,this.flags={};try{this.flags.query=a.filter.query.filtered.query.query_string.query}catch(b){this.flags.query=null}this._issues=null},this.create=function(){this.edit({})},this.cancel=function(){this.edited=null},this.save=function(){this.flags.is_desk&&(this.edited.desk=e),this.edited.filter={query:{filtered:{query:{query_string:{query:this.flags.query||"*"}}}}},this.edited.location=this.edited.location||"archive",f.save(d,this.edited).then(angular.bind(this,function(){this.reload(),this.cancel()}),angular.bind(this,function(a){this._issues=a._issues}))},this.reload=function(){var a={};return a.where=e?{desk:e}:{user:b.identity._id},f.query(a).then(angular.bind(this,function(a){this.views=a._items}))},c.$watch("selectedDesk",angular.bind(this,function(a){e=a?a._id:null,this.select(),this.reload()}))}}function c(){return{templateUrl:"scripts/superdesk-workspace/content/views/desk-views.html"}}a.$inject=["api","superdesk","workqueue"],b.$inject=["api","session"],angular.module("superdesk.workspace.content",[]).factory("ViewsCtrl",b).factory("ContentCtrl",a).directive("sdDeskViews",c)}(),function(){function a(a,b,c,d,e,f){a.versions=null,a.selected=null,a.users={};var g=function(c){b.users.getById(c).then(function(b){a.users[c]=b})},h=function(){return a.locked=a.item&&f.isLocked(a.item),b.archive.getByUrl(a.item._links.self.href+'?version=all&embedded={"user":1}').then(function(b){_.each(b._items,function(b){var c=b.creator||b.original_creator;c&&!a.users[c]&&g(c)}),a.versions=b,a.selected=_.find(a.versions._items,{_version:a.item._latest_version})})};a.openVersion=function(b){a.selected=b,a.item._version=b._version,a.item.headline=b.headline,a.item.body_html=b.body_html},a.revert=function(){a.save()},a.$watch("item",h)}a.$inject=["$scope","api","$location","notify","workqueue","lock"],angular.module("superdesk.authoring.versions",["superdesk.authoring.versions"]).config(["authoringWidgetsProvider",function(a){a.widget("versions",{icon:"revision",label:gettext("Versions"),template:"scripts/superdesk-authoring/versioning/views/versions.html"})}]).controller("VersioningWidgetCtrl",a)}(),function(){function a(a,b){b.initialize().then(function(){a.deskLookup=b.deskLookup})}a.$inject=["$scope","desks"],angular.module("superdesk.authoring.metadata",["superdesk.authoring.widgets"]).config(["authoringWidgetsProvider",function(a){a.widget("metadata",{icon:"info",label:gettext("Info"),template:"scripts/superdesk-authoring/metadata/views/metadata-widget.html",order:1})}]).controller("MetadataWidgetCtrl",a)}();